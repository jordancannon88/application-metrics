Resources:
  table8235A42E:
    Type: AWS::DynamoDB::Table
    Properties:
      KeySchema:
        - AttributeName: application
          KeyType: HASH
        - AttributeName: created_at
          KeyType: RANGE
      AttributeDefinitions:
        - AttributeName: application
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: applicationmetrics/table/Resource
  postServiceRole8DEE3DFE:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: applicationmetrics/post/ServiceRole/Resource
  postServiceRoleDefaultPolicy9F513012:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - xray:PutTraceSegments
              - xray:PutTelemetryRecords
            Effect: Allow
            Resource: "*"
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:Scan
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - table8235A42E
                  - Arn
              - Ref: AWS::NoValue
        Version: "2012-10-17"
      PolicyName: postServiceRoleDefaultPolicy9F513012
      Roles:
        - Ref: postServiceRole8DEE3DFE
    Metadata:
      aws:cdk:path: applicationmetrics/post/ServiceRole/DefaultPolicy/Resource
  postE6C9FCD1:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: "

          import boto3

          import os

          import datetime

          import logging

          import json

          from boto3.dynamodb.conditions import Key


          # Get the service resource.

          dynamodb = boto3.resource('dynamodb')


          # Instantiate a table resource object without actually

          # creating a DynamoDB table. Note that the attributes of this table

          # are lazy-loaded: a request is not made nor are the attribute

          # values populated until the attributes

          # on the table resource are accessed or its load() method is called.

          table = dynamodb.Table(os.environ['TABLE_NAME'])


          # Set logger level.

          logging.getLogger().setLevel(logging.INFO)



          def handler(event, context):

          \    # Print event to logs.

          \    logging.info('request: {}'.format(json.dumps(event)))


          \    # Formatted dates to Common Log Format (dd/MMM/yyyy:HH:mm:ss +-hhmm)

          \    # https://httpd.apache.org/docs/1.3/logs.html#common

          \    try:

          \        start_date = datetime.datetime.strptime(event['start_date'], '%Y-%m-%d').strftime(

          \            \"%d/%b/%Y:%H:%M:%S\") + \" +0000\"

          \        end_date = datetime.datetime.strptime(event['end_date'], '%Y-%m-%d').replace(hour=23, minute=59, second=59,

          \                                                                                     microsecond=999999).strftime(

          \            \"%d/%b/%Y:%H:%M:%S\") + \" +0000\"


          \        logging.info('dates: {}'.format(json.dumps({'start': start_date, 'end': end_date})))

          \    except Exception as e:

          \        # Format error message as json.

          \        error_json = json.dumps({

          \            'type': 'ValidationException',

          \            'message': 'Your values are incorrect.'

          \        })

          \        logging.warning(error_json)

          \        raise Exception(error_json)


          \    # Check the start day is before the end date.

          \    if start_date > end_date:

          \        # Format error message as json.

          \        error_json = json.dumps({

          \            'type': 'ValidationException',

          \            'message': 'The start date is further in the future than the end date.'

          \        })

          \        logging.warning(error_json)

          \        raise Exception(error_json)


          \    # Grab data from DynamoDB.

          \    try:

          \        # Query for application name and date range.

          \        data = table.query(

          \            KeyConditionExpression=Key('application').eq(event['application']) & Key('created_at').between(start_date,

          \                                                                                                           end_date)

          \        )

          \    except Exception as e:

          \        # Format error message as json.

          \        error_json = json.dumps({

          \            'type': 'UnknownException',

          \            'message': 'Something went wrong with the database.'

          \        })

          \        logging.error(error_json)

          \        raise Exception(error_json)


          \    # TODO:: Fix json.dumps for decimals.


          \    logging.info('data: {}'.format(data))


          \    # The dict for holding our dates and counts.

          \    response = {}


          \    # Format and count dates.

          \    try:

          \        for items in data['Items']:

          \            # Format the created_at date of each entry (YYYY-mm-dd).

          \            created_at = datetime.datetime.strptime(items['created_at'][:-6], '%d/%b/%Y:%H:%M:%S').strftime(\"%Y-%m-%d\")

          \            # Does the created_at date key already exists in the dict?

          \            if created_at in response:

          \                # It does, increment the value by 1.

          \                response[created_at] += 1

          \            else:

          \                # It does not, set a new key with a value of 1.

          \                response[created_at] = 1

          \    except Exception as e:

          \        # Format error message as json.

          \        error_json = json.dumps({

          \            'type': 'UnknownException',

          \            'message': 'Something went wrong with tallying dates.'

          \        })

          \        logging.error(error_json)

          \        raise Exception(error_json)


          \    logging.info('response: {}'.format(json.dumps(response)))


          \    return {

          \        'response': json.dumps(response)

          \    }


          \                                             "
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - postServiceRole8DEE3DFE
          - Arn
      Runtime: python3.6
      Environment:
        Variables:
          TABLE_NAME:
            Ref: table8235A42E
      TracingConfig:
        Mode: Active
    DependsOn:
      - postServiceRoleDefaultPolicy9F513012
      - postServiceRole8DEE3DFE
    Metadata:
      aws:cdk:path: applicationmetrics/post/Resource
  LogGroupF5B46931:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Join:
          - ""
          - - /aws/lambda/
            - Ref: postE6C9FCD1
      RetentionInDays: 731
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: applicationmetrics/LogGroup/Resource
  LambdaLogErrorReport973914AA:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '"[ERROR]"'
      LogGroupName:
        Ref: LogGroupF5B46931
      MetricTransformations:
        - DefaultValue: 0
          MetricName: LambdaErrors
          MetricNamespace: Lambdas
          MetricValue: "1"
    Metadata:
      aws:cdk:path: applicationmetrics/LambdaLogErrorReport/Resource
  LambdaLogMemoryUsage265834B6:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '[report="REPORT", request_id_name, request_id_value, duration_name, duration_value, duration_unit, duration_billed_name, duration_billed_name_2, duration_billed_value, duration_billed_unit, memory_max_name, memory_max_name_2, memory_max_value, memory_max_unit, memory_used_name, memory_used_name_2, memory_used_name_3, memory_used_value, memory_used_unit]'
      LogGroupName:
        Ref: LogGroupF5B46931
      MetricTransformations:
        - DefaultValue: 0
          MetricName: LambdaMemory
          MetricNamespace: Lambdas
          MetricValue: $memory_used_value
    Metadata:
      aws:cdk:path: applicationmetrics/LambdaLogMemoryUsage/Resource
  ApiGatewayServiceRole7D65739D:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: applicationmetrics/ApiGatewayServiceRole/Resource
  ApiGatewayServiceRoleDefaultPolicy39C0BA58:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: dynamodb:PutItem
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - table8235A42E
                - Arn
        Version: "2012-10-17"
      PolicyName: ApiGatewayServiceRoleDefaultPolicy39C0BA58
      Roles:
        - Ref: ApiGatewayServiceRole7D65739D
    Metadata:
      aws:cdk:path: applicationmetrics/ApiGatewayServiceRole/DefaultPolicy/Resource
  apiapplicationmetricsEF08131B:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: api_application_metrics
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/Resource
  apiapplicationmetricsDeployment9A46BDE634c6e5341aaedc7e445becd08fb914e5:
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      Description: Automatically created by the RestApi construct
    DependsOn:
      - apiapplicationmetricsapplicationsOPTIONS1ED88F35
      - apiapplicationmetricsapplicationsPOSTC87DC9FF
      - apiapplicationmetricsapplicationsPUT104FA63D
      - apiapplicationmetricsapplicationsD04BE6AA
      - apiapplicationmetricsOPTIONS15A60F8D
      - apiapplicationmetricsDefaultValidator47972F1A
      - apiapplicationmetricsErrorResponseModel1C07CF3B
      - apiapplicationmetricsPOSTRequestModel77B80C87
      - apiapplicationmetricsPOSTResponseModel5CEA1043
      - apiapplicationmetricsPUTRequestModelCFF13C8A
      - apiapplicationmetricsPUTResponseModel2A9E4FA4
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/Deployment/Resource
  apiapplicationmetricsDeploymentStageprodBDD290B7:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      DeploymentId:
        Ref: apiapplicationmetricsDeployment9A46BDE634c6e5341aaedc7e445becd08fb914e5
      MethodSettings:
        - DataTraceEnabled: true
          HttpMethod: "*"
          LoggingLevel: INFO
          MetricsEnabled: true
          ResourcePath: /*
      StageName: prod
      TracingEnabled: true
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/DeploymentStage.prod/Resource
  apiapplicationmetricsCloudWatchRole6761D886:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/CloudWatchRole/Resource
  apiapplicationmetricsAccountBF932892:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn:
        Fn::GetAtt:
          - apiapplicationmetricsCloudWatchRole6761D886
          - Arn
    DependsOn:
      - apiapplicationmetricsEF08131B
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/Account
  apiapplicationmetricsOPTIONS15A60F8D:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: OPTIONS
      ResourceId:
        Fn::GetAtt:
          - apiapplicationmetricsEF08131B
          - RootResourceId
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      AuthorizationType: NONE
      Integration:
        IntegrationResponses:
          - ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'OPTIONS,GET,PUT,POST,DELETE,PATCH,HEAD'"
            StatusCode: "204"
        RequestTemplates:
          application/json: "{ statusCode: 200 }"
        Type: MOCK
      MethodResponses:
        - ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
          StatusCode: "204"
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/Default/OPTIONS/Resource
  apiapplicationmetricsapplicationsD04BE6AA:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId:
        Fn::GetAtt:
          - apiapplicationmetricsEF08131B
          - RootResourceId
      PathPart: applications
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/Default/applications/Resource
  apiapplicationmetricsapplicationsOPTIONS1ED88F35:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: OPTIONS
      ResourceId:
        Ref: apiapplicationmetricsapplicationsD04BE6AA
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      AuthorizationType: NONE
      Integration:
        IntegrationResponses:
          - ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Methods: "'OPTIONS,GET,PUT,POST,DELETE,PATCH,HEAD'"
            StatusCode: "204"
        RequestTemplates:
          application/json: "{ statusCode: 200 }"
        Type: MOCK
      MethodResponses:
        - ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Methods: true
          StatusCode: "204"
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/Default/applications/OPTIONS/Resource
  apiapplicationmetricsapplicationsPUT104FA63D:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: PUT
      ResourceId:
        Ref: apiapplicationmetricsapplicationsD04BE6AA
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      AuthorizationType: NONE
      Integration:
        Credentials:
          Fn::GetAtt:
            - ApiGatewayServiceRole7D65739D
            - Arn
        IntegrationHttpMethod: POST
        IntegrationResponses:
          - ResponseParameters:
              method.response.header.Content-Type: "'application/json'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Credentials: "'true'"
            ResponseTemplates:
              application/json: '{"state": "Success", "message": "Updated items."}'
            StatusCode: "200"
          - ResponseParameters:
              method.response.header.Content-Type: "'application/json'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Credentials: "'true'"
            ResponseTemplates:
              application/json: '{"state": "Fail", "message": "Error, please contact the admin."}'
            SelectionPattern: .*400.*
            StatusCode: "400"
          - ResponseParameters:
              method.response.header.Content-Type: "'application/json'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Credentials: "'true'"
            ResponseTemplates:
              application/json: '{"state": "Fail", "message": "Error, please contact the admin."}'
            SelectionPattern: .*401.*
            StatusCode: "401"
          - ResponseParameters:
              method.response.header.Content-Type: "'application/json'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Credentials: "'true'"
            ResponseTemplates:
              application/json: '{"state": "Fail", "message": "Error, please contact the admin."}'
            SelectionPattern: .*403.*
            StatusCode: "403"
          - ResponseParameters:
              method.response.header.Content-Type: "'application/json'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Credentials: "'true'"
            ResponseTemplates:
              application/json: '{"state": "Fail", "message": "Error, please contact the admin."}'
            SelectionPattern: .*404.*
            StatusCode: "404"
          - ResponseParameters:
              method.response.header.Content-Type: "'application/json'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Credentials: "'true'"
            ResponseTemplates:
              application/json: '{"state": "Fail", "message": "Error, please contact the admin."}'
            SelectionPattern: .*413.*
            StatusCode: "413"
          - ResponseParameters:
              method.response.header.Content-Type: "'application/json'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Credentials: "'true'"
            ResponseTemplates:
              application/json: '{"state": "Fail", "message": "Error, please contact the admin."}'
            SelectionPattern: .*429.*
            StatusCode: "429"
          - ResponseParameters:
              method.response.header.Content-Type: "'application/json'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Credentials: "'true'"
            ResponseTemplates:
              application/json: '{"state": "Fail", "message": "Error, please contact the admin."}'
            SelectionPattern: 5\d{2}
            StatusCode: "500"
        PassthroughBehavior: NEVER
        RequestTemplates:
          application/json:
            Fn::Join:
              - ""
              - - '{"TableName": "'
                - Ref: table8235A42E
                - "\", \"Item\": {\"application\": {\"S\": \"$util.escapeJavaScript($input.path('$').application)\"}, \"operation\": {\"S\": \"$util.escapeJavaScript($input.path('$').operation)\"}, \"current_media_time\": {\"N\": \"$input.path('$').currentMediaTime\"}, \"source_ip\": {\"S\": \"$context.identity.sourceIp\"}, \"user_agent\": {\"S\": \"$context.identity.userAgent\"}, \"created_at\": {\"S\": \"$context.requestTime\"}}}"
        Type: AWS
        Uri:
          Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :apigateway:us-west-2:dynamodb:action/PutItem
      MethodResponses:
        - ResponseModels:
            application/json:
              Ref: apiapplicationmetricsPUTResponseModel2A9E4FA4
          ResponseParameters:
            method.response.header.Content-Type: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Credentials: true
          StatusCode: "200"
        - ResponseModels:
            application/json:
              Ref: apiapplicationmetricsErrorResponseModel1C07CF3B
          ResponseParameters:
            method.response.header.Content-Type: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Credentials: true
          StatusCode: "400"
        - ResponseModels:
            application/json:
              Ref: apiapplicationmetricsErrorResponseModel1C07CF3B
          ResponseParameters:
            method.response.header.Content-Type: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Credentials: true
          StatusCode: "401"
        - ResponseModels:
            application/json:
              Ref: apiapplicationmetricsErrorResponseModel1C07CF3B
          ResponseParameters:
            method.response.header.Content-Type: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Credentials: true
          StatusCode: "403"
        - ResponseModels:
            application/json:
              Ref: apiapplicationmetricsErrorResponseModel1C07CF3B
          ResponseParameters:
            method.response.header.Content-Type: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Credentials: true
          StatusCode: "404"
        - ResponseModels:
            application/json:
              Ref: apiapplicationmetricsErrorResponseModel1C07CF3B
          ResponseParameters:
            method.response.header.Content-Type: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Credentials: true
          StatusCode: "413"
        - ResponseModels:
            application/json:
              Ref: apiapplicationmetricsErrorResponseModel1C07CF3B
          ResponseParameters:
            method.response.header.Content-Type: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Credentials: true
          StatusCode: "429"
        - ResponseModels:
            application/json:
              Ref: apiapplicationmetricsErrorResponseModel1C07CF3B
          ResponseParameters:
            method.response.header.Content-Type: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Credentials: true
          StatusCode: "500"
      RequestModels:
        application/json:
          Ref: apiapplicationmetricsPUTRequestModelCFF13C8A
      RequestValidatorId:
        Ref: apiapplicationmetricsDefaultValidator47972F1A
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/Default/applications/PUT/Resource
  apiapplicationmetricsapplicationsPOSTApiPermissionapplicationmetricsapiapplicationmetricsB618AE9APOSTapplications0EC7A9CA:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - postE6C9FCD1
          - Arn
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Join:
          - ""
          - - "arn:"
            - Ref: AWS::Partition
            - ":execute-api:us-west-2:"
            - Ref: AWS::AccountId
            - ":"
            - Ref: apiapplicationmetricsEF08131B
            - /
            - Ref: apiapplicationmetricsDeploymentStageprodBDD290B7
            - /POST/applications
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/Default/applications/POST/ApiPermission.applicationmetricsapiapplicationmetricsB618AE9A.POST..applications
  apiapplicationmetricsapplicationsPOSTApiPermissionTestapplicationmetricsapiapplicationmetricsB618AE9APOSTapplications75A94C17:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - postE6C9FCD1
          - Arn
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Join:
          - ""
          - - "arn:"
            - Ref: AWS::Partition
            - ":execute-api:us-west-2:"
            - Ref: AWS::AccountId
            - ":"
            - Ref: apiapplicationmetricsEF08131B
            - /test-invoke-stage/POST/applications
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/Default/applications/POST/ApiPermission.Test.applicationmetricsapiapplicationmetricsB618AE9A.POST..applications
  apiapplicationmetricsapplicationsPOSTC87DC9FF:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId:
        Ref: apiapplicationmetricsapplicationsD04BE6AA
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      AuthorizationType: NONE
      Integration:
        IntegrationHttpMethod: POST
        IntegrationResponses:
          - ResponseParameters:
              method.response.header.Content-Type: "'application/json'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Credentials: "'true'"
            ResponseTemplates:
              application/json: "{\"counts\":$util.parseJson($input.json('$.response'))}"
            StatusCode: "200"
          - ResponseParameters:
              method.response.header.Content-Type: "'application/json'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Credentials: "'true'"
            ResponseTemplates:
              application/json: " {\"state\": \"Fail\",\"message\": \"$util.parseJson($input.path('$.errorMessage')).message\"} "
            SelectionPattern: .*ValidationException.*
            StatusCode: "400"
          - ResponseParameters:
              method.response.header.Content-Type: "'application/json'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Credentials: "'true'"
            ResponseTemplates:
              application/json: '{"state": "Fail", "message": "Error, please contact the admin."}'
            SelectionPattern: >-
              (

              |.)+
            StatusCode: "500"
        PassthroughBehavior: NEVER
        RequestTemplates:
          application/json: "{\"start_date\": \"$util.escapeJavaScript($input.path('$').startDate)\", \"end_date\": \"$util.escapeJavaScript($input.path('$').endDate)\", \"application\": \"$util.escapeJavaScript($input.path('$').application)\"}"
        Type: AWS
        Uri:
          Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :apigateway:us-west-2:lambda:path/2015-03-31/functions/
              - Fn::GetAtt:
                  - postE6C9FCD1
                  - Arn
              - /invocations
      MethodResponses:
        - ResponseModels:
            application/json:
              Ref: apiapplicationmetricsPOSTResponseModel5CEA1043
          ResponseParameters:
            method.response.header.Content-Type: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Credentials: true
          StatusCode: "200"
        - ResponseModels:
            application/json:
              Ref: apiapplicationmetricsErrorResponseModel1C07CF3B
          ResponseParameters:
            method.response.header.Content-Type: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Credentials: true
          StatusCode: "400"
        - ResponseModels:
            application/json:
              Ref: apiapplicationmetricsErrorResponseModel1C07CF3B
          ResponseParameters:
            method.response.header.Content-Type: true
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Credentials: true
          StatusCode: "500"
      RequestModels:
        application/json:
          Ref: apiapplicationmetricsPOSTRequestModel77B80C87
      RequestValidatorId:
        Ref: apiapplicationmetricsDefaultValidator47972F1A
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/Default/applications/POST/Resource
  apiapplicationmetricsDefaultValidator47972F1A:
    Type: AWS::ApiGateway::RequestValidator
    Properties:
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      ValidateRequestBody: true
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/DefaultValidator/Resource
  apiapplicationmetricsPUTRequestModelCFF13C8A:
    Type: AWS::ApiGateway::Model
    Properties:
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      ContentType: application/json
      Name: PUTRequestModel
      Schema:
        properties:
          application:
            minLength: 1
            type: string
          operation:
            minLength: 1
            type: string
          currentMediaTime:
            minLength: 1
            type: number
        required:
          - application
          - operation
          - currentMediaTime
        $schema: http://json-schema.org/draft-04/schema#
        title: PUTRequestModel
        type: object
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/PUTRequestModel/Resource
  apiapplicationmetricsPOSTRequestModel77B80C87:
    Type: AWS::ApiGateway::Model
    Properties:
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      ContentType: application/json
      Name: POSTRequestModel
      Schema:
        properties:
          startDate:
            minLength: 1
            type: string
          endDate:
            minLength: 1
            type: string
          application:
            minLength: 1
            type: string
        required:
          - startDate
          - endDate
          - application
        $schema: http://json-schema.org/draft-04/schema#
        title: POSTRequestModel
        type: object
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/POSTRequestModel/Resource
  apiapplicationmetricsPUTResponseModel2A9E4FA4:
    Type: AWS::ApiGateway::Model
    Properties:
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      ContentType: application/json
      Name: PUTResponseModel
      Schema:
        properties:
          state:
            type: string
          message:
            type: string
        $schema: http://json-schema.org/draft-04/schema#
        title: PUTResponseModel
        type: object
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/PUTResponseModel/Resource
  apiapplicationmetricsPOSTResponseModel5CEA1043:
    Type: AWS::ApiGateway::Model
    Properties:
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      ContentType: application/json
      Name: POSTResponseModel
      Schema:
        properties:
          counts:
            type: object
        $schema: http://json-schema.org/draft-04/schema#
        title: POSTResponseModel
        type: object
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/POSTResponseModel/Resource
  apiapplicationmetricsErrorResponseModel1C07CF3B:
    Type: AWS::ApiGateway::Model
    Properties:
      RestApiId:
        Ref: apiapplicationmetricsEF08131B
      ContentType: application/json
      Name: ErrorResponseModel
      Schema:
        properties:
          state:
            type: string
          message:
            type: string
        $schema: http://json-schema.org/draft-04/schema#
        title: ErrorResponseModel
        type: object
    Metadata:
      aws:cdk:path: applicationmetrics/api_application_metrics/ErrorResponseModel/Resource
  LambdaLogError492F06FA:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      ActionsEnabled: true
      AlarmActions:
        - Ref: ErrorsFA5270DE
      AlarmDescription: Looks for logs reported as errors and reports if any is found.
      MetricName: LambdaErrors
      Namespace: Lambdas
      Period: 60
      Statistic: Average
      Threshold: 0
      TreatMissingData: notBreaching
    Metadata:
      aws:cdk:path: applicationmetrics/LambdaLogError/Resource
  LambdaLogMemoryFC6E04E8:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      ActionsEnabled: true
      AlarmActions:
        - Ref: ErrorsFA5270DE
      AlarmDescription: Reads memory usage in MB reported in logs and reports if too high.
      MetricName: LambdaMemory
      Namespace: Lambdas
      Period: 60
      Statistic: Maximum
      Threshold: 110
      TreatMissingData: notBreaching
    Metadata:
      aws:cdk:path: applicationmetrics/LambdaLogMemory/Resource
  LambdaDuration59E1FBB6:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      ActionsEnabled: true
      AlarmActions:
        - Ref: ErrorsFA5270DE
      AlarmDescription: Uses AWS metrics to graph duration for the Lambda function.
      Dimensions:
        - Name: FunctionName
          Value:
            Ref: postE6C9FCD1
      MetricName: Duration
      Namespace: AWS/Lambda
      Period: 60
      Statistic: Maximum
      Threshold: 1000
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: applicationmetrics/LambdaDuration/Resource
  LambdaErrorC8481906:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      ActionsEnabled: true
      AlarmDescription: Uses AWS metrics to count errors for the Lambda function.
      Dimensions:
        - Name: FunctionName
          Value:
            Ref: postE6C9FCD1
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 60
      Statistic: Maximum
      Threshold: 0
      TreatMissingData: notBreaching
    Metadata:
      aws:cdk:path: applicationmetrics/LambdaError/Resource
  ApiGateway4XXError4C50865A:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      ActionsEnabled: true
      Dimensions:
        - Name: ApiName
          Value: api_application_metrics
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Period: 60
      Statistic: Average
      Threshold: 0
      TreatMissingData: notBreaching
    Metadata:
      aws:cdk:path: applicationmetrics/ApiGateway4XXError/Resource
  ApiGateway5XXError161A0A83:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      ActionsEnabled: true
      AlarmActions:
        - Ref: ErrorsFA5270DE
      Dimensions:
        - Name: ApiName
          Value: api_application_metrics
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Period: 60
      Statistic: Average
      Threshold: 0
      TreatMissingData: notBreaching
    Metadata:
      aws:cdk:path: applicationmetrics/ApiGateway5XXError/Resource
  ApiGateway11E7F47B:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardBody:
        Fn::Join:
          - ""
          - - '{"widgets":[{"type":"metric","width":24,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"HTTP Errors","region":"'
            - Ref: AWS::Region
            - '","metrics":[["AWS/ApiGateway","4XXError","ApiName","api_application_metrics",{"color":"#ff8000"}],["AWS/ApiGateway","5XXError","ApiName","api_application_metrics",{"color":"#ff4d4d"}]],"yAxis":{}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"4xxErrorAlarms","region":"'
            - Ref: AWS::Region
            - '","annotations":{"alarms":["'
            - Fn::GetAtt:
                - ApiGateway4XXError4C50865A
                - Arn
            - '"]},"yAxis":{}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"5xxErrorAlarms","region":"'
            - Ref: AWS::Region
            - '","annotations":{"alarms":["'
            - Fn::GetAtt:
                - ApiGateway5XXError161A0A83
                - Arn
            - '"]},"yAxis":{}}}]}'
    Metadata:
      aws:cdk:path: applicationmetrics/ApiGateway/Resource
  LambdaPOSTA3CA2981:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardBody:
        Fn::Join:
          - ""
          - - '{"widgets":[{"type":"metric","width":24,"height":3,"x":0,"y":0,"properties":{"view":"singleValue","region":"'
            - Ref: AWS::Region
            - '","metrics":[["AWS/Lambda","Invocations","FunctionName","'
            - Ref: postE6C9FCD1
            - '",{"color":"#0052cc","stat":"Sum"}],["AWS/Lambda","Errors","FunctionName","'
            - Ref: postE6C9FCD1
            - '",{"color":"#ff3333","stat":"Sum"}],["AWS/Lambda","Throttles","FunctionName","'
            - Ref: postE6C9FCD1
            - '",{"color":"#ffff1a","stat":"Sum"}],["AWS/Lambda","Duration","FunctionName","'
            - Ref: postE6C9FCD1
            - '",{"color":"#5cd65c","label":"Duration (max)","stat":"Maximum"}],["Lambdas","LambdaMemory",{"color":"#ff8000","label":"Memory (max)","stat":"Maximum"}]]}},{"type":"metric","width":6,"height":6,"x":0,"y":3,"properties":{"view":"timeSeries","title":"Error","region":"'
            - Ref: AWS::Region
            - '","metrics":[["AWS/Lambda","Errors","FunctionName","'
            - Ref: postE6C9FCD1
            - '",{"color":"#ff4d4d","label":"Errors","stat":"Sum"}]],"yAxis":{}}},{"type":"metric","width":6,"height":6,"x":6,"y":3,"properties":{"view":"timeSeries","title":"LogError","region":"'
            - Ref: AWS::Region
            - '","metrics":[["Lambdas","LambdaErrors",{"color":"#ff4d4d","label":"Errors"}]],"yAxis":{}}},{"type":"metric","width":6,"height":6,"x":12,"y":3,"properties":{"view":"timeSeries","title":"Memory","region":"'
            - Ref: AWS::Region
            - '","metrics":[["Lambdas","LambdaMemory",{"color":"#ff4d4d","label":"Maximum","stat":"Maximum"}],["Lambdas","LambdaMemory",{"color":"#5cd65c","label":"Minimum","stat":"Minimum"}],["Lambdas","LambdaMemory",{"color":"#ff8000","label":"Average"}]],"yAxis":{}}},{"type":"metric","width":6,"height":6,"x":18,"y":3,"properties":{"view":"timeSeries","title":"Duration","region":"'
            - Ref: AWS::Region
            - '","metrics":[["AWS/Lambda","Duration","FunctionName","'
            - Ref: postE6C9FCD1
            - '",{"color":"#ff4d4d","label":"Maximum","stat":"Maximum"}],["AWS/Lambda","Duration","FunctionName","'
            - Ref: postE6C9FCD1
            - '",{"color":"#5cd65c","label":"Minimum","stat":"Minimum"}],["AWS/Lambda","Duration","FunctionName","'
            - Ref: postE6C9FCD1
            - '",{"color":"#ff8000","label":"Average"}]],"yAxis":{}}},{"type":"metric","width":6,"height":6,"x":0,"y":9,"properties":{"view":"timeSeries","title":"ErrorAlarms","region":"'
            - Ref: AWS::Region
            - '","annotations":{"alarms":["'
            - Fn::GetAtt:
                - LambdaErrorC8481906
                - Arn
            - '"]},"yAxis":{}}},{"type":"metric","width":6,"height":6,"x":6,"y":9,"properties":{"view":"timeSeries","title":"LogErrorAlarms","region":"'
            - Ref: AWS::Region
            - '","annotations":{"alarms":["'
            - Fn::GetAtt:
                - LambdaLogError492F06FA
                - Arn
            - '"]},"yAxis":{}}},{"type":"metric","width":6,"height":6,"x":12,"y":9,"properties":{"view":"timeSeries","title":"MemoryAlarms","region":"'
            - Ref: AWS::Region
            - '","annotations":{"alarms":["'
            - Fn::GetAtt:
                - LambdaLogMemoryFC6E04E8
                - Arn
            - '"]},"yAxis":{}}},{"type":"metric","width":6,"height":6,"x":18,"y":9,"properties":{"view":"timeSeries","title":"DurationAlarms","region":"'
            - Ref: AWS::Region
            - '","annotations":{"alarms":["'
            - Fn::GetAtt:
                - LambdaDuration59E1FBB6
                - Arn
            - '"]},"yAxis":{}}}]}'
    Metadata:
      aws:cdk:path: applicationmetrics/LambdaPOST/Resource
  ErrorsFA5270DE:
    Type: AWS::SNS::Topic
    Metadata:
      aws:cdk:path: applicationmetrics/Errors/Resource
  ErrorsxxxgmailcomAE20D91F:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn:
        Ref: ErrorsFA5270DE
      Endpoint: xxx@gmail.com
    Metadata:
      aws:cdk:path: applicationmetrics/Errors/xxx@gmail.com/Resource
  Errorsxxxyahoocom12EBCDE0:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn:
        Ref: ErrorsFA5270DE
      Endpoint: xxx@yahoo.com
    Metadata:
      aws:cdk:path: applicationmetrics/Errors/xxx@yahoo.com/Resource
  CDKMetadata:
    Type: AWS::CDK::Metadata
    Properties:
      Modules: aws-cdk=1.21.1,@aws-cdk/assets=1.21.1,@aws-cdk/aws-apigateway=1.21.1,@aws-cdk/aws-applicationautoscaling=1.21.1,@aws-cdk/aws-autoscaling=1.21.1,@aws-cdk/aws-autoscaling-common=1.21.1,@aws-cdk/aws-certificatemanager=1.21.1,@aws-cdk/aws-cloudformation=1.21.1,@aws-cdk/aws-cloudwatch=1.21.1,@aws-cdk/aws-cloudwatch-actions=1.21.1,@aws-cdk/aws-dynamodb=1.21.1,@aws-cdk/aws-ec2=1.21.1,@aws-cdk/aws-elasticloadbalancing=1.21.1,@aws-cdk/aws-elasticloadbalancingv2=1.21.1,@aws-cdk/aws-events=1.21.1,@aws-cdk/aws-iam=1.21.1,@aws-cdk/aws-kms=1.21.1,@aws-cdk/aws-lambda=1.21.1,@aws-cdk/aws-logs=1.21.1,@aws-cdk/aws-route53=1.21.1,@aws-cdk/aws-s3=1.21.1,@aws-cdk/aws-s3-assets=1.21.1,@aws-cdk/aws-sns=1.21.1,@aws-cdk/aws-sns-subscriptions=1.21.1,@aws-cdk/aws-sqs=1.21.1,@aws-cdk/aws-ssm=1.21.1,@aws-cdk/core=1.21.1,@aws-cdk/cx-api=1.21.1,@aws-cdk/region-info=1.21.1,jsii-runtime=Python/3.7.6
Outputs:
  apiapplicationmetricsEndpointED738B7A:
    Value:
      Fn::Join:
        - ""
        - - https://
          - Ref: apiapplicationmetricsEF08131B
          - .execute-api.us-west-2.
          - Ref: AWS::URLSuffix
          - /
          - Ref: apiapplicationmetricsDeploymentStageprodBDD290B7
          - /

